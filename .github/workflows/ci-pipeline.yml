name: CI x86_64

on: [push, pull_request, merge_group]
env:
  ARCH: x86_64
  CC: gcc
  CONTAINER_NAMESPACE: ghcr.io/lifang-zhang/odp-docker-images
  OS: ubuntu_20.04
  IMG_TAG_VER: ml-non-x86-dockers

jobs:
  Build_arm64:
    runs-on: ubuntu-20.04
    env:
      ARCH: arm64
      CONF: "--enable-dpdk-shared --with-ort-path=/usr/local/"
    strategy:
      fail-fast: false
      matrix:
        cc: [gcc, clang]
        conf: ['', '--enable-abi-compat', 'CFLAGS=-march=armv8.2-a', 'CFLAGS=-march=armv8-a+lse',
               '--with-crypto=armv8crypto', '--enable-wfe-locks']
    steps:
      - uses: actions/checkout@v3
      - run: sudo docker run -i -v `pwd`:/odp --privileged --shm-size 8g -e CC="${{matrix.cc}}"
               -e CONF="${CONF} ${{matrix.conf}}" $CONTAINER_NAMESPACE/odp-ci-${OS}-${ARCH}:${IMG_TAG_VER} /odp/scripts/ci/build_${ARCH}.sh
      - if: ${{ failure() }}
        uses: ./.github/actions/build-failure-log

  Build_armhf:
    runs-on: ubuntu-20.04
    env:
      ARCH: armhf
    strategy:
      fail-fast: false
      matrix:
        cc: [gcc, clang]
        conf: ['', '--enable-abi-compat']
    steps:
      - uses: actions/checkout@v3
      - run: sudo docker run -i -v `pwd`:/odp --privileged --shm-size 8g -e CC="${{matrix.cc}}"
               -e CONF="${{matrix.conf}}" $CONTAINER_NAMESPACE/odp-ci-${OS}-${ARCH}:${IMG_TAG_VER} /odp/scripts/ci/build_${ARCH}.sh
      - if: ${{ failure() }}
        uses: ./.github/actions/build-failure-log

  Build_ppc64el:
    runs-on: ubuntu-20.04
    env:
      ARCH: ppc64el
      CONF: "--enable-dpdk-shared"
    strategy:
      fail-fast: false
      matrix:
        cc: [gcc, clang]
        conf: ['', '--enable-abi-compat']
    steps:
      - uses: actions/checkout@v3
      - run: sudo docker run -i -v `pwd`:/odp --privileged --shm-size 8g -e CC="${{matrix.cc}}"
               -e CONF="${CONF} ${{matrix.conf}}" $CONTAINER_NAMESPACE/odp-ci-${OS}-${ARCH}:${IMG_TAG_VER} /odp/scripts/ci/build_${ARCH}.sh
      - if: ${{ failure() }}
        uses: ./.github/actions/build-failure-log

  Build_i386:
    runs-on: ubuntu-20.04
    env:
      ARCH: i386
      OS: ubuntu_18.04
    strategy:
      fail-fast: false
      matrix:
        cc: [gcc, clang]
        conf: ['', '--enable-abi-compat']
    steps:
      - uses: actions/checkout@v3
      - run: sudo docker run -i -v `pwd`:/odp --privileged --shm-size 8g -e CC="${{matrix.cc}}"
               -e CONF="${{matrix.conf}}" $CONTAINER_NAMESPACE/odp-ci-${OS}-${ARCH}:${IMG_TAG_VER} /odp/scripts/ci/build_${ARCH}.sh
      - if: ${{ failure() }}
        uses: ./.github/actions/build-failure-log
